name: local-validator
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  SOLANA_CLI: v2.3.9
  DOUBLEZERO_OFFCHAIN_GIT_INSTALL: --git https://github.com/doublezerofoundation/doublezero-offchain.git

jobs:
  mainnet-fork-upgrade:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Solana toolchain
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/$SOLANA_CLI/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Generate ~/.config/solana/id.json
        run: solana-keygen new --silent --no-bip39-passphrase
      - name: Install `doublezero-solana-fork` CLI
        run: cargo install doublezero-solana-fork-cli $DOUBLEZERO_OFFCHAIN_GIT_INSTALL
      - name: Start Solana mainnet-beta fork in background
        run: doublezero-solana-fork -um --reset --god-mode > /dev/null 2>&1 &
      - name: Install `doublezero-revenue-distribution-admin` CLI
        run: cargo install doublezero-revenue-distribution-admin-cli $DOUBLEZERO_OFFCHAIN_GIT_INSTALL
      - name: Build Revenue Distribution program
        run: make build-artifacts
      - name: Wait for local validator to be ready
        run: |
          echo "Waiting for solana-test-validator to start..."
          for i in {1..30}; do
            if solana cluster-version -ul > /dev/null 2>&1; then
              solana cluster-version -ul
              break
            fi
            echo "Attempt $i: solana-test-validator not ready yet, waiting..."
            sleep 5
          done
          if ! solana cluster-version -ul > /dev/null 2>&1; then
            echo "solana-test-validator failed to start within timeout"
            exit 1
          fi
      - name: Upgrade Revenue Distribution program
        run: solana program deploy -ul --program-id dzrevZC94tBLwuHw1dyynZxaXTWyp7yocsinyEVPtt4 artifacts-mainnet-beta/doublezero_revenue_distribution.so
      - name: Wait for upgrade to finalize
        run: sleep 15
      - name: Perform Revenue Distribution program migration
        run: doublezero-revenue-distribution-admin migrate-program-accounts -ul -v
      - name: Perform Revenue Distribution program migration again
        run: doublezero-revenue-distribution-admin migrate-program-accounts -ul -v
